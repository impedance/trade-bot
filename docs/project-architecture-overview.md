# Архитектура и потоки данных `robot.xlsb`

## Общая схема
- Excel-книга выступает как торговый бот: читает рыночные данные из QUIK (лист `quotes` и OHLC-листы `gold/mxi/br/si`) и записывает заявки/сделки в листы `orders`/`deals`.
- VBA-код управляет циклом: каждые минуты пишет heartbeat, снимает блокировки, запускает стратегии, а затем разбирает новые сделки и ставит защитные заявки.
- Заявки формируются как текстовые транзакции QUIK (`ACTION=NEW_ORDER` и `TAKE_PROFIT_AND_STOP_LIMIT_ORDER`) и сохраняются во внешний файл `tri.tri`, откуда QUIK их забирает.
- Логи пишутся в файлы `Logs/<дата>.log`, чтобы отследить решения и ошибки.

## Основные модули VBA
- **General**: центральный цикл `main`, контроль времени торговли, обработка листов `strategies/deals`, постановка стоп/тейк заявок после сделок, heartbeat и управление блокировками. 
- **SupportFunctions**: вспомогательные процедуры (подсчёт строк, форматирование времени, поиск экстремумов, рассчёт комиссий и PnL).
- **Orders**: сборка строк транзакций QUIK (лимитные заявки, стоп-лимит+тейк-профит), запись в `tri.tri`, унифицированные комментарии `o-...`/`c-...` для связи с листами.
- **Log**: вывод событий в файл и при необходимости на лист; используется во всех стратегиях и сервисных функциях.
- **Deals**: разбор листа `deals`, обновление позиций и комиссий на листе `strategies`, синхронизация защитных ордеров.
- **Стратегические модули**: 
  - `s7` — стратегии S7/RS7 на окнах 120/180 минут (пробой диапазона от средней линии).
  - `s8` — S8 с фиксированными стоп/тейк вокруг средней диапазона.
  - `s6` — AR6 с паттерном из трёх 15-минутных свечей.
  - `s10` — Rs101/102 с трёхсвечным паттерном на 60/120 минутах.
  - `br_30min_strat3` — отдельная стратегия для BR на 30-минутном таймфрейме (детали аналогичны S-семейству, работает через общие утилиты).

## Данные и параметры
- **Лист `strategies`** — таблица конфигурации и текущего состояния: название стратегии, связанный лист котировок (`Sheet`), код инструмента (`SecCode`), таймфрейм, порог `delta`, уровни стоп/тейк (`sl/tp`), проскальзывание (`slip`), объём (`Qty`), текущая позиция (`Pos`), флаг блокировки, экстремумы (`Max/Min/Avg`), направление (`Direction`), входная цена (`EnterPrice`).
- **Листы котировок**: 
  - `quotes` — потоковые данные QUIK с heartbeat; служит индикатором живости соединения.
  - `gold`, `mxi`, `br`, `si` — исторические ряды OHLC для расчёта сигналов по каждому инструменту.
- **Листы транзакций**: `orders` и `deals` повторяют журналы QUIK и используются для подтверждения заявок и расчёта фактических позиций/комиссий.

## Потоки данных
1. **Получение рынка**: QUIK (через DDE/ODBC или импорт) заполняет лист `quotes` и OHLC-листы. Heartbeat в `quotes` проверяется модулем `General` для контроля связи.
2. **Расчёт сигналов**: модуль `General` раз в минуту обходит `strategies` и вызывает нужную стратегию (S7/S8/AR6/Rs101/102 и т.д.) в зависимости от настроек строки и торгового окна.
3. **Выставление заявок**: стратегия считает уровни входа/стоп/тейк, записывает состояние (Max/Min/Avg, Direction, EnterPrice) на `strategies`, блокирует повторный вход и вызывает `BuyLimit`/`SellLimit` из `Orders`, которые пишут транзакцию в `tri.tri` с комментарием `o-...`.
4. **Учёт сделок**: когда в `deals` появляется запись с комментарием `o-...` или `c-...`, модуль `Deals` через `UpdatePos` корректирует позицию и PnL в `strategies` и ставит защитный стоп/тейк (`StopLimitAndTakeProfit`) для открытых позиций.
5. **Логирование**: все ключевые действия (heartbeat, проверки стратегий, выставление заявок, обработка сделок) проходят через модуль `Log` в файл `Logs/<дата>.log`.

## Правила управления и ограничения
- Торговые окна: AR6 — 10:44–18:30; S7/RS7 — 09:00–18:30; S8 без явного ограничения; Rs101/102 — 09:00–18:30. Это предотвращает сделки вне ликвидных часов.
- Блокировки (`BlockTrade/UnblockTrades`) защищают от повторного входа до завершения серии сделок и снимаются в начале каждой минуты.
- Риск-контроль: стоп и тейк рассчитываются из параметров `sl/tp` и зеркального направления позиции; проскальзывание `slip` учитывается при расчёте лимитных цен.
- Зависимости от инфраструктуры: жёстко задан класс и счёт (`CLASSCODE=SPBFUT`, `SPBFUTL6ho2`); без активного канала QUIK листы не обновятся, и стратегии останутся без сигналов.

## Итоговая картина для пользователя
- Таблица `strategies` — основной пульт: включает/отключает стратегии, задаёт объёмы и пороги, хранит текущую позицию и последние экстремумы.
- При активных стратегиях бот сам ставит заявки в QUIK через файл `tri.tri`, пишет их в лог и в случае исполнения выставляет защитные стоп/тейк.
- Контроль здоровья — по heartbeat в `quotes` и лог-файлам; при пропадании данных стратегии не запустятся.
