# Итоговые выводы по `robot.xlsb`

## Картина работы
- Главная процедура `main` в модуле `General` работает в цикле: пишет heartbeat в лог, снимает блокировки, обходит лист `strategies` и запускает стратегии только при отсутствии позиции и блокировок, затем обрабатывает лист `deals`, пересчитывает позиции через `UpdatePos` и ставит защитные заявки `StopLimitAndTakeProfit` для новых открытий.
- Все стратегии работают по OHLC-листам (`gold`, `mxi`, `br`, `si`) и параметрам листа `strategies`; после расчётов они вызывают `BuyLimit`/`SellLimit`, формируют строки QUIK `ACTION=NEW_ORDER` с `CLASSCODE=SPBFUT` и аккаунтом `SPBFUTL6ho2`, сохраняют их в файл `tri.tri` и пишут события в `Logs/<дата>.log`.

## Интеграция с QUIK и данными
- Листы `quotes`, `orders`, `deals` повторяют поля журналов QUIK, а OHLC-листы заполняются историей котировок; формулы и явные ссылки на DDE/ODBC в выгрузке не видны, что указывает на внешнюю подстановку значений (DDE/ODBC или импорт файлов).
- В модуле `Orders` запросы к QUIK строятся как текстовые транзакции, отправляемые через файл `tri.tri`; защитные заявки создаются как `TAKE_PROFIT_AND_STOP_LIMIT_ORDER` с тем же комментарием стратегии для сопоставления в листе `deals`.

## Ключевые стратегии
- **S7/RS7**: пробой диапазона за 120/180 минут, расчёт Max/Min/Avg, направление `B/S`, вход по касанию средней линии, комментарии `o-S7_<tf>-<delta>-<sl>-<tp>` и `o-RS7_120-...`.
- **S8_120_fixedSLTP**: фиксированные SL/TP вокруг `EnterPrice` (средняя диапазона), вход по достижении `CurrentLow`/`CurrentHigh`, комментарии `o-S8_120-<delta>-<sl>-<tp>`.
- **AR6_15 / Rs101 / Rs102**: паттерн из трёх свечей (15/60/120 минут) с зеркальной заявкой лимитом; комментарии `o-AR6_15-...`, `o-Rs101_60-...`, `o-Rs102_<tf>-...`.

## Риски и технический долг
- Жёстко зашиты `CLASSCODE=SPBFUT` и счёт `SPBFUTL6ho2` во всех транзакциях; при переносе на другой счёт/рынок требуется изменить код.
- Источник данных листов (`quotes`, OHLC) не описан в коде выгрузки; без активного DDE/ODBC-подключения стратегический цикл не получит котировок, что затрудняет воспроизводимость.
- Защитные ордера ставятся сразу после обнаружения сделки по комментарию; при несогласованности комментариев в QUIK возможны пропуски стоп/тейк заявок.

## Открытые вопросы и следующие шаги
- Подтвердить механизм загрузки котировок и heartbeat (поиск DDE/ODBC-инициализаций в полном VBA-дампе или настройках QUIK).
- Проверить актуальность параметров стратегий на листе `strategies` (таймфреймы, delta/sl/tp, EnterPrice) и соответствие реальным инструментам из QUIK.
- Прогнать тестовый прогон в Excel с подключением к демо QUIK: убедиться, что файл `tri.tri` формируется, заявки отражаются в `orders/deals`, а лог фиксирует все шаги цикла.
