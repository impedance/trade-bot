# Анализ бизнес-логики `robot.xlsb`

## Основной поток
- Главный цикл (`main` в модуле `General`) пишет heartbeat, снимает блокировки через `UnblockTrades`, затем проходит по строкам листа `strategies` и запускает стратегии при отсутствии блокировки и открытой позиции. После проверки стратегий обрабатывает лист `deals`: помечает новые сделки, парсит комментарии `o-`/`c-`, пересчитывает позицию через `UpdatePos` и ставит защитные стоп/тейк заявки вызовом `StopLimitAndTakeProfit` для открытых позиций.

## Стратегии S-семейства (пробой диапазона)
- **S7_120 / S7_180** (`s7.bas`): для окна 120/180 минут вычисляет `Max`, `Min`, `Avg=(Max+Min)/2` и Direction: `B`, если `PriceOpen > PriceClose`, иначе `S`. При превышении диапазоном порога `delta` обновляет экстремумы на листе `strategies`, логирует параметры, блокирует повторный вход (`BlockTrade`) и отправляет лимитные заявки: в лонг при `CurrentLow < Avg` и Direction=`B`, в шорт при `CurrentHigh > Avg` и Direction=`S`. Комментарий заявок формируется как `o-S7_<tf>-<delta>-<sl>-<tp>`.
- **RS7_120** (`s7.bas`): аналогично S7_120, но обновление экстремумов и Direction происходит только при нулевой позиции. После превышения `delta` формирует вход: лонг при `CurrentLow < Avg` и Direction=`B`, шорт при `CurrentHigh > Avg` и Direction=`S`. Комментарии вида `o-RS7_120-<delta>-<sl>-<tp>`.

## Стратегия S8 (фиксированные SL/TP по центру диапазона)
- **S8_120_fixedSLTP** (`s8.bas`): использует окно 120 минут, обновляет `Max/Min/Avg` и Direction (`B`, если `PriceOpen < PriceClose`, иначе `S`) на листе `strategies`. Ключевой уровень входа — значение `EnterPrice` в колонке 16: Direction `B` выставляет покупку, когда `CurrentLow <= EnterPrice`, Direction `S` — продажу при `CurrentHigh >= EnterPrice`. Заявки лимитные с комментарием `o-S8_120-<delta>-<sl>-<tp>`.

## Стратегии AR/Rs (паттерны трёх свечей)
- **AR6_15** (`s6.bas`): берёт три 15-минутные свечи и при последовательности трёх падающих/растущих тел с разрывом не менее `delta` ставит лимитные заявки в сторону разворота третьей свечи. Комментарий заявок `o-AR6_15-<delta>-<sl>-<tp>`.
- **Rs101** (`s10.bas`): анализирует три часовые свечи. Шорт при двух медвежьих и одной бычьей свече с обновлением high/low, лонг — зеркально. Take-profit рассчитывается как расстояние между close и экстремумом третьей свечи, умноженное на коэффициент `k`; комментарий `o-Rs101_60-<k>-<sl>-<tp>`. Слиппедж фиксирован в ноль.
- **Rs102** (`s10.bas`): использует три двухчасовые свечи (`timeframe=120`). При аналогичном паттерне входа формирует лимитные заявки с фиксированными `sl` и `tp` (tp = заданное значение), комментарий `o-Rs102_<tf>-0-<sl>-<tp>`.

## Формирование заявок и защита позиций
- Все стратегии вызывают `BlockTrade` для снятия блокировки перед входом и пишут подробные параметры в лог. Заявки создаются через `BuyLimit`/`SellLimit`, которые формируют строки транзакций QUIK `ACTION=NEW_ORDER` с `CLASSCODE=SPBFUT` и аккаунтом `SPBFUTL6ho2` и сохраняют их в файл `tri.tri`; защитные ордера ставятся через `StopLimitAndTakeProfit` с типом `TAKE_PROFIT_AND_STOP_LIMIT_ORDER` и тем же комментарием стратегии.
