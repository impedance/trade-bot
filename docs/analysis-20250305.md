# Анализ `robot.xlsb` — выгрузка VBA и логика

## Прогресс
- Получен текстовый дамп макросов через `olevba` и сохранен в `docs/vba-code.txt`.
- Отмечено выполнение шага по извлечению VBA-кода в `plan.md`.

## Архитектура и поток управления
- Главная процедура `main` в модуле `General` работает циклически: пишет heartbeat в лог, снимает блокировки, затем проходится по строкам листа `strategies` и запускает стратегии, если позиция нулевая и нет блокировки. Для каждой стратегии проверяются временные окна: AR6 только в 10:44–18:30, S7/RS7 в 09:00–18:30, S8 без явного окна, Rs101/102 в 09:00–18:30.
- После обработки стратегий `main` перебирает лист `deals`: для необработанных сделок логирует событие, парсит комментарий (префиксы `o`/`c`), вызывает `UpdatePos` для корректировки позиций и комиссий, а при открытиях выставляет связанные стоп- и тейк-профит заявки через `StopLimitAndTakeProfit` с зеркальным направлением.

## Интеграция с QUIK
- Модуль `Orders` формирует строки транзакций QUIK и пишет их в файл `tri.tri` рядом с книгой. `BuyLimit`/`SellLimit` создают `ACTION=NEW_ORDER` с фиксированным `CLASSCODE=SPBFUT`, аккаунтом `SPBFUTL6ho2` и комментарием из кода стратегии. `StopLimitAndTakeProfit` формирует заявку типа `TAKE_PROFIT_AND_STOP_LIMIT_ORDER` с параметрами стоп-лимита и тейк-профита. Каждая запись уходит в лог через `Logging`.
- `Logging` пишет диагностические строки в файл `Logs/<дата>.log` рядом с книгой, что фиксирует все запросы и события.

## Стратегии и расчеты
- Стратегии работают на OHLC-данных листов (`gold`, `mxi`, `br`, `si` и т.п.). `S7_120` и `S7_180` вычисляют максимум/минимум по окнам 120/180 минут, сохраняют Max/Min/Avg и Direction в лист `strategies`, блокируют повторный вход через `BlockTrade`, затем открывают лимитные заявки при пробитии средней линии (Avg) с комментарием вида `o-S7_<tf>-<delta>-<sl>-<tp>`.
- Функции `UpdatePos`/`UpdatePosWithoutTP` обновляют позицию, PnL и комиссии на листе `strategies`, сбрасывают экстремумы/направление при наличии открытой позиции и поддерживают стратегии с фиксированным и плавающим take-profit.

## Наблюдения по данным листов
- В книге доступны листы `portfel`, `strategies`, `quotes`, `orders`, `deals`, `gold`, `mxi`, `br`, `si`. Листы `quotes`, `orders`, `deals` выглядят как выгрузки QUIK с полями «Оборот/Цена/Комментарий/Состояние» и комментарием `o-...`/`c-...`, а OHLC-листы содержат минутные ряды.

## Открытые вопросы
- В коде нет явных DDE/ODBC вызовов — предположительно, листы заполняются внешним подключением QUIK (DDE/ODBC) или импортом файлов, что требует отдельной проверки источников данных.
- Реализация `BlockTrade`, `UnblockTrades`, `S8_120_fixedSLTP`, `Rs101/102`, `RS7_120` требует дальнейшего чтения, чтобы оценить правила блокировок и риск-контроля.
